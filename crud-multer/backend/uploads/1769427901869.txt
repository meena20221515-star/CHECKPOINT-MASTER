
        checkpointmaster
  table.js


import React, { useState } from "react";
import {
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Paper,
  IconButton,
  Chip,
  Stack,
  Typography,
  Box,
  Tooltip,
  Alert,
  TextField,
  Button,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Divider,
  List,
  ListItem,
  ListItemText
} from "@mui/material";
import {
  Visibility as ViewIcon,
  Edit as EditIcon,
  Delete as DeleteIcon,
  Attachment as AttachmentIcon,
  Task as TaskIcon,
  Add as AddIcon,
  Save as SaveIcon,
  Cancel as CancelIcon,
  Check as CheckIcon,
  Clear as ClearIcon
} from "@mui/icons-material";

export default function CheckpointTable({ checkpoints, onDelete, onView, onEdit }) {
  const [editDialogOpen, setEditDialogOpen] = useState(false);
  const [selectedCheckpoint, setSelectedCheckpoint] = useState(null);
  const [editCheckpoint, setEditCheckpoint] = useState("");
  const [editDate, setEditDate] = useState("");
  const [editTodos, setEditTodos] = useState([]);
  const [editTodoInput, setEditTodoInput] = useState("");
  const [editingTodoIndex, setEditingTodoIndex] = useState(-1);
  const [editTempValue, setEditTempValue] = useState("");
  const [message, setMessage] = useState("");

  const formatDate = (dateString) => {
    return new Date(dateString).toLocaleDateString("en-US", {
      month: "short",
      day: "numeric",
      year: "numeric"
    });
  };

  // Format date for input field (YYYY-MM-DD)
  const formatDateForInput = (dateString) => {
    const date = new Date(dateString);
    return date.toISOString().split('T')[0];
  };

  // Open edit dialog for checkpoint
  const handleOpenEditDialog = (checkpoint) => {
    setSelectedCheckpoint(checkpoint);
    setEditCheckpoint(checkpoint.checkpoint);
    setEditDate(formatDateForInput(checkpoint.date));
    setEditTodos([...checkpoint.todos]);
    setEditTodoInput("");
    setEditingTodoIndex(-1);
    setEditTempValue("");
    setMessage("");
    setEditDialogOpen(true);
  };

  // Add new todo ONLY
  const handleAddNewTodo = () => {
    if (!editTodoInput.trim()) {
      setMessage("Please enter todo text!");
      return;
    }
    
    const newTodo = editTodoInput.trim();
    setEditTodos(prev => [...prev, newTodo]);
    setEditTodoInput("");
    setMessage(`Added: "${newTodo}"`);
  };

  // Start inline editing for a todo
  const startEditTodo = (index) => {
    setEditingTodoIndex(index);
    setEditTempValue(editTodos[index]);
  };

  // Save inline edit
  const saveEditTodo = () => {
    if (!editTempValue.trim()) {
      setMessage("Todo cannot be empty!");
      return;
    }
    
    const updatedTodos = [...editTodos];
    updatedTodos[editingTodoIndex] = editTempValue.trim();
    setEditTodos(updatedTodos);
    setEditingTodoIndex(-1);
    setEditTempValue("");
    setMessage(`Todo #${editingTodoIndex + 1} updated`);
  };

  // Cancel inline edit
  const cancelEditTodo = () => {
    setEditingTodoIndex(-1);
    setEditTempValue("");
  };

  // Delete todo
  const handleDeleteTodo = (index) => {
    if (window.confirm(`Delete todo #${index + 1}: "${editTodos[index]}"?`)) {
      setEditTodos(prev => prev.filter((_, i) => i !== index));
      
      if (index === editingTodoIndex) {
        setEditingTodoIndex(-1);
        setEditTempValue("");
      }
      
      setMessage(`Deleted todo #${index + 1}`);
    }
  };

  // Save checkpoint changes
  const handleSaveCheckpoint = () => {
    if (!editCheckpoint.trim()) {
      setMessage("Checkpoint name required!");
      return;
    }
    
    if (editTodos.length === 0) {
      setMessage("At least one todo required!");
      return;
    }

    if (!editDate) {
      setMessage("Date required!");
      return;
    }

    // Prepare updated checkpoint data
    const updatedCheckpoint = {
      ...selectedCheckpoint,
      checkpoint: editCheckpoint.trim(),
      date: editDate,
      todos: editTodos
    };

    // Call parent's edit function
    onEdit(updatedCheckpoint);
    setEditDialogOpen(false);
    setMessage("");
  };

  // Close dialog
  const handleCloseDialog = () => {
    setEditDialogOpen(false);
    setMessage("");
  };

  // Listen for switch to edit mode event
  React.useEffect(() => {
    const handleSwitchToEdit = (e) => {
      handleOpenEditDialog(e.detail);
    };

    window.addEventListener("switchToEdit", handleSwitchToEdit);
    return () => window.removeEventListener("switchToEdit", handleSwitchToEdit);
  }, []);

  if (checkpoints.length === 0) {
    return (
      <Alert severity="info" sx={{ mt: 2 }}>
        No checkpoints found. Create your first checkpoint above!
      </Alert>
    );
  }

  // Reverse the chronological order - newest at top
  const reversedCheckpoints = [...checkpoints].reverse();

  return (
    <>
      <TableContainer component={Paper} elevation={0} variant="outlined">
        <Table size="medium">
          <TableHead>
            <TableRow sx={{ bgcolor: "primary.50" }}>
              <TableCell sx={{ fontWeight: "bold", width: 60 }}>S.NO</TableCell>
              <TableCell sx={{ fontWeight: "bold" }}>Checkpoint</TableCell>
              <TableCell sx={{ fontWeight: "bold", width: 120 }}>Date</TableCell>
              <TableCell sx={{ fontWeight: "bold" }}>Todos</TableCell>
              <TableCell sx={{ fontWeight: "bold", width: 100 }}>Files</TableCell>
              <TableCell align="center" sx={{ fontWeight: "bold", width: 150 }}>Actions</TableCell>
            </TableRow>
          </TableHead>
          <TableBody>
            {reversedCheckpoints.map((cp, index) => (
              <TableRow 
                key={cp._id} 
                hover
                sx={{ 
                  '&:hover': { bgcolor: 'action.hover' },
                  '&:last-child td': { borderBottom: 0 }
                }}
              >
                {/* Fixed sequential numbering: count from top to bottom */}
                <TableCell>
                  <Chip 
                    label={index + 1} 
                    size="small" 
                    color="primary" 
                    variant="outlined"
                  />
                </TableCell>
                <TableCell>
                  <Typography variant="body2" fontWeight="medium">
                    {cp.checkpoint}
                  </Typography>
                  <Typography variant="caption" color="text.secondary">
                    Created: {formatDate(cp.createdAt || cp.date)}
                  </Typography>
                </TableCell>
                <TableCell>
                  <Typography variant="body2">
                    {formatDate(cp.date)}
                  </Typography>
                </TableCell>
                <TableCell>
                  <Stack spacing={0.5}>
                    {cp.todos.slice(0, 2).map((todo, i) => (
                      <Box key={i} sx={{ display: "flex", alignItems: "center", gap: 1 }}>
                        <TaskIcon fontSize="small" color="action" />
                        <Typography variant="body2" noWrap>
                          {todo}
                        </Typography>
                      </Box>
                    ))}
                    {cp.todos.length > 2 && (
                      <Typography variant="caption" color="text.secondary">
                        +{cp.todos.length - 2} more
                      </Typography>
                    )}
                  </Stack>
                </TableCell>
                <TableCell>
                  <Stack direction="row" spacing={0.5}>
                    {cp.files && cp.files.slice(0, 2).map((file, i) => (
                      <Tooltip key={i} title={`File ${i + 1}`}>
                        <AttachmentIcon fontSize="small" color="action" />
                      </Tooltip>
                    ))}
                    {cp.files && cp.files.length > 2 && (
                      <Typography variant="caption" color="text.secondary">
                        +{cp.files.length - 2}
                      </Typography>
                    )}
                  </Stack>
                </TableCell>
                <TableCell align="center">
                  <Stack direction="row" spacing={1} justifyContent="center">
                    <Tooltip title="View Details">
                      <IconButton
                        size="small"
                        color="info"
                        onClick={() => onView(cp._id)}
                      >
                        <ViewIcon fontSize="small" />
                      </IconButton>
                    </Tooltip>
                    <Tooltip title="Edit">
                      <IconButton
                        size="small"
                        color="warning"
                        onClick={() => handleOpenEditDialog(cp)}
                      >
                        <EditIcon fontSize="small" />
                      </IconButton>
                    </Tooltip>
                    <Tooltip title="Delete">
                      <IconButton
                        size="small"
                        color="error"
                        onClick={() => onDelete(cp._id)}
                      >
                        <DeleteIcon fontSize="small" />
                      </IconButton>
                    </Tooltip>
                  </Stack>
                </TableCell>
              </TableRow>
            ))}
          </TableBody>
        </Table>
      </TableContainer>

      {/* Edit Dialog */}
      <Dialog 
        open={editDialogOpen} 
        onClose={handleCloseDialog}
        maxWidth="md" 
        fullWidth
        PaperProps={{ sx: { maxHeight: '85vh' } }}
      >
        <DialogTitle>
          <Box display="flex" alignItems="center" justifyContent="space-between">
            <Typography variant="h6">Edit Checkpoint</Typography>
            <Chip 
              label={`${editTodos.length} Todos`} 
              color="primary" 
              size="small"
            />
          </Box>
        </DialogTitle>

        <DialogContent dividers sx={{ p: 3 }}>
          {/* Main Message Alert */}
          {message && (
            <Alert severity="info" sx={{ mb: 3 }} onClose={() => setMessage("")}>
              {message}
            </Alert>
          )}

          {/* ========== SECTION 1: CHECKPOINT INFO ========== */}
          <Box mb={4}>
            <Typography variant="subtitle1" fontWeight="bold" color="primary" gutterBottom>
              Checkpoint Information
            </Typography>
            <Divider sx={{ mb: 2 }} />
            
            <Stack spacing={2}>
              <Box>
                <Typography variant="body2" fontWeight="bold" gutterBottom>
                  Checkpoint Name *
                </Typography>
                <TextField
                  fullWidth
                  size="small"
                  value={editCheckpoint}
                  onChange={(e) => setEditCheckpoint(e.target.value)}
                  placeholder="Enter checkpoint name"
                />
              </Box>
              
              <Box>
                <Typography variant="body2" fontWeight="bold" gutterBottom>
                  Date *
                </Typography>
                <TextField
                  fullWidth
                  size="small"
                  type="date"
                  value={editDate}
                  onChange={(e) => setEditDate(e.target.value)}
                  InputLabelProps={{ shrink: true }}
                />
              </Box>
            </Stack>
          </Box>

          {/* ========== SECTION 2: ADD NEW TODO ========== */}
          <Box mb={4}>
            <Typography variant="subtitle1" fontWeight="bold" color="primary" gutterBottom>
              Add New Todo
            </Typography>
            <Divider sx={{ mb: 2 }} />
            
            <Box display="flex" gap={2} alignItems="center">
              <TextField
                fullWidth
                size="small"
                placeholder="Type new todo here..."
                value={editTodoInput}
                onChange={(e) => setEditTodoInput(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && handleAddNewTodo()}
                sx={{ flex: 1 }}
              />
              
              <Button
                variant="contained"
                color="primary"
                onClick={handleAddNewTodo}
                disabled={!editTodoInput.trim()}
                startIcon={<AddIcon />}
                sx={{ 
                  height: 40,
                  px: 3
                }}
              >
                Add
              </Button>
            </Box>
          </Box>

          {/* ========== SECTION 3: TODO LIST ========== */}
          <Box>
            <Typography variant="subtitle1" fontWeight="bold" color="primary" gutterBottom>
              Todo List
            </Typography>
            <Divider sx={{ mb: 2 }} />
            
            {editTodos.length === 0 ? (
              <Alert severity="warning" sx={{ mb: 2 }}>
                No todos added yet. Add your first todo above.
              </Alert>
            ) : (
              <Paper 
                variant="outlined" 
                sx={{ 
                  maxHeight: 250, 
                  overflow: 'auto',
                  border: '1px solid #e0e0e0',
                  borderRadius: 1,
                  backgroundColor: '#fafafa'
                }}
              >
                <List dense sx={{ p: 0 }}>
                  {editTodos.map((todo, index) => (
                    <React.Fragment key={index}>
                      <ListItem 
                        sx={{ 
                          px: 2,
                          py: 1.5,
                          backgroundColor: index === editingTodoIndex ? '#e8f5e9' : 'transparent',
                          '&:hover': { backgroundColor: index === editingTodoIndex ? '#e8f5e9' : '#f0f0f0' }
                        }}
                      >
                        <Box sx={{ display: 'flex', alignItems: 'center', width: '100%' }}>
                          {/* Todo Number Badge */}
                          <Chip 
                            label={`${index + 1}`}
                            size="small" 
                            sx={{ 
                              mr: 2,
                              backgroundColor: index === editingTodoIndex ? "#4caf50" : "#1976d2",
                              color: "white",
                              fontWeight: "bold",
                              width: 32,
                              height: 32
                            }}
                          />
                          
                          {/* Todo Text or Edit Input */}
                          {index === editingTodoIndex ? (
                            <Box sx={{ display: 'flex', alignItems: 'center', flex: 1, gap: 1 }}>
                              <TextField
                                fullWidth
                                size="small"
                                value={editTempValue}
                                onChange={(e) => setEditTempValue(e.target.value)}
                                autoFocus
                                onKeyPress={(e) => e.key === 'Enter' && saveEditTodo()}
                                sx={{ 
                                  backgroundColor: 'white',
                                  borderRadius: 1
                                }}
                              />
                              <IconButton
                                size="small"
                                onClick={saveEditTodo}
                                color="success"
                                sx={{ 
                                  border: '1px solid',
                                  borderColor: 'success.main',
                                  backgroundColor: 'white'
                                }}
                                title="Save changes"
                              >
                                <CheckIcon fontSize="small" />
                              </IconButton>
                              <IconButton
                                size="small"
                                onClick={cancelEditTodo}
                                color="error"
                                sx={{ 
                                  border: '1px solid',
                                  borderColor: 'error.main',
                                  backgroundColor: 'white'
                                }}
                                title="Cancel edit"
                              >
                                <ClearIcon fontSize="small" />
                              </IconButton>
                            </Box>
                          ) : (
                            <>
                              {/* Todo Text Display */}
                              <ListItemText 
                                primary={
                                  <Typography 
                                    variant="body2" 
                                    sx={{ 
                                      flex: 1,
                                      wordBreak: 'break-word'
                                    }}
                                  >
                                    {todo}
                                  </Typography>
                                }
                              />
                              
                              {/* Action Buttons - Only show when NOT editing */}
                              <Box sx={{ display: 'flex', gap: 1, ml: 2 }}>
                                <IconButton
                                  size="small"
                                  onClick={() => startEditTodo(index)}
                                  color="primary"
                                  sx={{ 
                                    border: '1px solid',
                                    borderColor: 'primary.main',
                                    borderRadius: 1,
                                    width: 32,
                                    height: 32,
                                    backgroundColor: 'white'
                                  }}
                                  title="Edit this todo"
                                >
                                  <EditIcon fontSize="small" />
                                </IconButton>
                                
                                <IconButton
                                  size="small"
                                  onClick={() => handleDeleteTodo(index)}
                                  color="error"
                                  sx={{ 
                                    border: '1px solid',
                                    borderColor: 'error.main',
                                    borderRadius: 1,
                                    width: 32,
                                    height: 32,
                                    backgroundColor: 'white'
                                  }}
                                  title="Delete this todo"
                                >
                                  <DeleteIcon fontSize="small" />
                                </IconButton>
                              </Box>
                            </>
                          )}
                        </Box>
                      </ListItem>
                      
                      {/* Divider between items */}
                      {index < editTodos.length - 1 && (
                        <Divider component="li" />
                      )}
                    </React.Fragment>
                  ))}
                </List>
              </Paper>
            )}
            
            <Box sx={{ mt: 2 }}>
              <Typography variant="caption" color="text.secondary">
                Click <EditIcon fontSize="inherit" sx={{ verticalAlign: 'middle', mx: 0.5 }} /> to edit a todo inline
              </Typography>
            </Box>
          </Box>
        </DialogContent>

        {/* ========== DIALOG ACTIONS ========== */}
        <DialogActions sx={{ px: 3, py: 2, borderTop: 1, borderColor: 'divider' }}>
          <Box display="flex" justifyContent="space-between" width="100%" alignItems="center">
            <Box>
              <Typography variant="caption" color="text.secondary">
                {editTodos.length === 0 ? 'Add at least 1 todo' : `Total: ${editTodos.length} todo(s)`}
              </Typography>
            </Box>
            
            <Box display="flex" gap={2}>
              <Button
                onClick={handleCloseDialog}
                variant="outlined"
                color="inherit"
                startIcon={<CancelIcon />}
              >
                Cancel
              </Button>
              
              <Button
                onClick={handleSaveCheckpoint}
                variant="contained"
                color="success"
                disabled={editTodos.length === 0 || !editCheckpoint.trim() || !editDate}
                startIcon={<SaveIcon />}
                sx={{ minWidth: 140 }}
              >
                Save Changes
              </Button>
            </Box>
          </Box>
        </DialogActions>
      </Dialog>
    </>
  );
}


-----------------------------------------------------
               correct version 

       import React, { useState, useMemo } from "react";
import {
  Box,
  Paper,
  Typography,
  Chip,
  Alert,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Divider,
  List,
  ListItem,
  ListItemText,
  Button,
  IconButton,
  TextField,
  Tooltip,
  Stack,
  Grid,
  Card,
  CardContent,
  Input,
} from "@mui/material";
import {
  DataGrid,
  GridToolbarContainer,
  GridToolbarFilterButton,
  GridToolbarExport,
  GridToolbarQuickFilter,
  GridActionsCellItem,
} from "@mui/x-data-grid";
import {
  Visibility as ViewIcon,
  Edit as EditIcon,
  Delete as DeleteIcon,
  Attachment as AttachmentIcon,
  Task as TaskIcon,
  Add as AddIcon,
  Save as SaveIcon,
  Cancel as CancelIcon,
  Check as CheckIcon,
  Clear as ClearIcon,
  FolderOpen as FolderOpenIcon,
  Download as DownloadIcon,
  CloudUpload as UploadIcon,
  InsertDriveFile as FileIcon,
} from "@mui/icons-material";

export default function CheckpointTable({ checkpoints, onDelete, onView, onEdit }) {
  const [editDialogOpen, setEditDialogOpen] = useState(false);
  const [selectedCheckpoint, setSelectedCheckpoint] = useState(null);
  const [editCheckpoint, setEditCheckpoint] = useState("");
  const [editDate, setEditDate] = useState("");
  const [editTodos, setEditTodos] = useState([]);
  const [editTodoInput, setEditTodoInput] = useState("");
  const [editingTodoIndex, setEditingTodoIndex] = useState(-1);
  const [editTempValue, setEditTempValue] = useState("");
  const [message, setMessage] = useState("");
  
  // File states for edit dialog
  const [editFiles, setEditFiles] = useState([]);
  const [newFile, setNewFile] = useState(null);
  const [fileName, setFileName] = useState("");
  const [viewingFileIndex, setViewingFileIndex] = useState(-1);

  const formatDate = (dateString) => {
    if (!dateString) return "N/A";
    try {
      return new Date(dateString).toLocaleDateString("en-US", {
        month: "short",
        day: "numeric",
        year: "numeric"
      });
    } catch (error) {
      console.error("Date formatting error:", error);
      return "Invalid Date";
    }
  };

  const formatDateForInput = (dateString) => {
    if (!dateString) return "";
    try {
      const date = new Date(dateString);
      return date.toISOString().split('T')[0];
    } catch (error) {
      console.error("Date input formatting error:", error);
      return "";
    }
  };

  // Open edit dialog
  const handleOpenEditDialog = (checkpoint) => {
    setSelectedCheckpoint(checkpoint);
    setEditCheckpoint(checkpoint.checkpoint || "");
    setEditDate(formatDateForInput(checkpoint.date));
    setEditTodos([...checkpoint.todos] || []);
    setEditFiles([...checkpoint.files] || []);
    setEditTodoInput("");
    setEditingTodoIndex(-1);
    setEditTempValue("");
    setFileName("");
    setNewFile(null);
    setViewingFileIndex(-1);
    setMessage("");
    setEditDialogOpen(true);
  };

  // File handling in edit dialog
  const handleFileUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      setNewFile(file);
      setFileName(file.name);
    }
  };

  const handleAddFile = () => {
    if (!newFile && !fileName.trim()) {
      setMessage("Please select a file or enter a file name!");
      return;
    }

    const newFileObj = {
      id: Date.now(),
      name: fileName || newFile.name,
      type: newFile ? newFile.type : "Unknown",
      size: newFile ? newFile.size : 0,
      file: newFile,
      uploadedDate: new Date().toISOString()
    };

    setEditFiles(prev => [...prev, newFileObj]);
    setNewFile(null);
    setFileName("");
    setMessage(`Added file: ${newFileObj.name}`);
  };

  const handleViewFile = (index) => {
    setViewingFileIndex(index);
  };

  const handleEditFileName = (index, newName) => {
    if (!newName.trim()) {
      setMessage("File name cannot be empty!");
      return;
    }

    const updatedFiles = [...editFiles];
    updatedFiles[index] = { ...updatedFiles[index], name: newName.trim() };
    setEditFiles(updatedFiles);
    setMessage(`Renamed file to: ${newName}`);
  };

  const handleDeleteFile = (index) => {
    if (window.confirm(`Delete file "${editFiles[index].name}"?`)) {
      const updatedFiles = editFiles.filter((_, i) => i !== index);
      setEditFiles(updatedFiles);
      if (viewingFileIndex === index) {
        setViewingFileIndex(-1);
      }
      setMessage(`Deleted file: ${editFiles[index].name}`);
    }
  };

  const handleDownloadFile = (file) => {
    if (file.file) {
      const url = URL.createObjectURL(file.file);
      const a = document.createElement('a');
      a.href = url;
      a.download = file.name;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    } else {
      // Handle server-side file download
      setMessage(`Downloading ${file.name}...`);
    }
  };

  // Todo functions
  const handleAddTodo = () => {
    if (!editTodoInput.trim()) {
      setMessage("Please enter todo text!");
      return;
    }
    
    const newTodo = editTodoInput.trim();
    setEditTodos(prev => [...prev, newTodo]);
    setEditTodoInput("");
    setMessage(`Added: "${newTodo}"`);
  };

  const startTodoEdit = (index) => {
    setEditingTodoIndex(index);
    setEditTempValue(editTodos[index]);
  };

  const saveTodoEdit = () => {
    if (!editTempValue.trim()) {
      setMessage("Todo cannot be empty!");
      return;
    }
    
    const updatedTodos = [...editTodos];
    updatedTodos[editingTodoIndex] = editTempValue.trim();
    setEditTodos(updatedTodos);
    setEditingTodoIndex(-1);
    setEditTempValue("");
    setMessage(`Todo #${editingTodoIndex + 1} updated`);
  };

  const cancelTodoEdit = () => {
    setEditingTodoIndex(-1);
    setEditTempValue("");
  };

  const deleteTodo = (index) => {
    if (window.confirm(`Delete todo #${index + 1}: "${editTodos[index]}"?`)) {
      setEditTodos(prev => prev.filter((_, i) => i !== index));
      
      if (index === editingTodoIndex) {
        setEditingTodoIndex(-1);
        setEditTempValue("");
      }
      
      setMessage(`Deleted todo #${index + 1}`);
    }
  };

  // Save checkpoint
  const handleSaveCheckpoint = () => {
    if (!editCheckpoint.trim()) {
      setMessage("Checkpoint name required!");
      return;
    }
    
    if (editTodos.length === 0) {
      setMessage("At least one todo required!");
      return;
    }

    if (!editDate) {
      setMessage("Date required!");
      return;
    }

    const updatedCheckpoint = {
      ...selectedCheckpoint,
      checkpoint: editCheckpoint.trim(),
      date: editDate,
      todos: editTodos,
      files: editFiles
    };

    onEdit(updatedCheckpoint);
    setEditDialogOpen(false);
    setMessage("");
  };

  const handleCloseDialog = () => {
    setEditDialogOpen(false);
    setMessage("");
  };

  // Prepare rows for DataGrid
  const rows = useMemo(() => {
    if (!Array.isArray(checkpoints)) return [];
    
    return checkpoints.map((cp, index) => ({
      id: cp._id || `id-${index}`,
      serialNo: index + 1,
      checkpoint: cp.checkpoint || "Unnamed",
      date: cp.date ? new Date(cp.date) : new Date(),
      formattedDate: formatDate(cp.date),
      createdAt: cp.createdAt ? formatDate(cp.createdAt) : formatDate(cp.date),
      todos: Array.isArray(cp.todos) ? cp.todos : [],
      files: Array.isArray(cp.files) ? cp.files : [],
      filesCount: Array.isArray(cp.files) ? cp.files.length : 0,
    }));
  }, [checkpoints]);

  // Define columns
  const columns = [
    {
      field: 'serialNo',
      headerName: 'S.NO',
      width: 80,
      renderCell: (params) => (
        <Chip 
          label={params.value} 
          size="small" 
          color="primary" 
          variant="outlined"
        />
      ),
    },
    {
      field: 'checkpoint',
      headerName: 'Checkpoint',
      flex: 1,
      minWidth: 200,
      renderCell: (params) => (
        <Box>
          <Typography variant="body2" fontWeight="medium">
            {params.value}
          </Typography>
          <Typography variant="caption" color="text.secondary">
            Created: {params.row.createdAt}
          </Typography>
        </Box>
      ),
    },
    {
      field: 'formattedDate',
      headerName: 'Date',
      width: 120,
    },
    {
      field: 'todos',
      headerName: 'Todos',
      flex: 1,
      minWidth: 200,
      renderCell: (params) => (
        <Stack spacing={0.5}>
          {params.row.todos.slice(0, 2).map((todo, i) => (
            <Box key={i} sx={{ display: "flex", alignItems: "center", gap: 1 }}>
              <TaskIcon fontSize="small" color="action" />
              <Typography variant="body2" noWrap sx={{ maxWidth: '200px' }}>
                {todo}
              </Typography>
            </Box>
          ))}
          {params.row.todos.length > 2 && (
            <Typography variant="caption" color="text.secondary">
              +{params.row.todos.length - 2} more
            </Typography>
          )}
        </Stack>
      ),
    },
    {
      field: 'files',
      headerName: 'Files',
      width: 120,
      renderCell: (params) => (
        <Box display="flex" alignItems="center" gap={1}>
          {params.row.filesCount > 0 && (
            <>
              <FolderOpenIcon fontSize="small" color="primary" />
              <Typography variant="body2" color="primary">
                {params.row.filesCount}
              </Typography>
            </>
          )}
        </Box>
      ),
    },
    {
      field: 'actions',
      headerName: 'Actions',
      type: 'actions',
      width: 150,
      getActions: (params) => [
        <GridActionsCellItem
          icon={<Tooltip title="View Details"><ViewIcon /></Tooltip>}
          label="View"
          onClick={() => onView(params.id)}
        />,
        <GridActionsCellItem
          icon={<Tooltip title="Edit"><EditIcon /></Tooltip>}
          label="Edit"
          onClick={() => {
            const checkpoint = checkpoints.find(cp => cp._id === params.id);
            if (checkpoint) handleOpenEditDialog(checkpoint);
          }}
        />,
        <GridActionsCellItem
          icon={<Tooltip title="Delete"><DeleteIcon /></Tooltip>}
          label="Delete"
          onClick={() => {
            if (window.confirm('Delete this checkpoint?')) {
              onDelete(params.id);
            }
          }}
          sx={{ color: 'error.main' }}
        />,
      ],
    },
  ];

  // Custom toolbar
  function CustomToolbar() {
    return (
      <GridToolbarContainer sx={{ p: 2, borderBottom: 1, borderColor: 'divider' }}>
        <Box sx={{ flexGrow: 1, display: 'flex', alignItems: 'center', gap: 2 }}>
          <Typography variant="h6" fontWeight="bold" color="primary">
            Checkpoints ({rows.length})
          </Typography>
          <Box sx={{ flexGrow: 1 }}>
            <GridToolbarQuickFilter 
              placeholder="Search checkpoints, todos..." 
              variant="outlined"
              size="small"
              sx={{ 
                width: { xs: '100%', sm: '300px' },
                '& .MuiInputBase-root': { height: 40 }
              }}
            />
          </Box>
        </Box>
        <Box sx={{ display: 'flex', gap: 1 }}>
          <GridToolbarFilterButton />
          <GridToolbarExport />
        </Box>
      </GridToolbarContainer>
    );
  }

  if (!checkpoints || checkpoints.length === 0) {
    return (
      <Alert severity="info" sx={{ mt: 2 }}>
        No checkpoints found.
      </Alert>
    );
  }

  return (
    <>
      {/* DataGrid Table */}
      <Paper elevation={0} variant="outlined" sx={{ height: 500, width: '100%' }}>
        <DataGrid
          rows={rows}
          columns={columns}
          slots={{ toolbar: CustomToolbar }}
          slotProps={{ toolbar: { showQuickFilter: true } }}
          initialState={{
            pagination: { paginationModel: { page: 0, pageSize: 10 } },
            sorting: { sortModel: [{ field: 'date', sort: 'desc' }] },
          }}
          pageSizeOptions={[5, 10, 25]}
          sx={{
            border: 'none',
            '& .MuiDataGrid-columnHeaders': {
              backgroundColor: 'primary.50',
              fontWeight: 'bold',
            },
          }}
        />
      </Paper>

      {/* Edit Dialog with File Management */}
      <Dialog 
        open={editDialogOpen} 
        onClose={handleCloseDialog}
        maxWidth="lg" 
        fullWidth
        PaperProps={{ sx: { maxHeight: '90vh' } }}
      >
        <DialogTitle>
          <Typography variant="h6" gutterBottom>
            Edit Checkpoint: {editCheckpoint}
          </Typography>
          <Box display="flex" gap={2} flexWrap="wrap">
            <Chip label={`${editTodos.length} Todos`} color="primary" size="small" />
            <Chip label={`${editFiles.length} Files`} color="secondary" size="small" />
          </Box>
        </DialogTitle>

        <DialogContent dividers sx={{ p: 3 }}>
          {message && (
            <Alert severity="info" sx={{ mb: 3 }} onClose={() => setMessage("")}>
              {message}
            </Alert>
          )}

          <Grid container spacing={3}>
            {/* Left Column: Basic Info & Todos */}
            <Grid item xs={12} md={6}>
              {/* Basic Info */}
              <Box mb={4}>
                <Typography variant="subtitle1" fontWeight="bold" gutterBottom>
                  Basic Information
                </Typography>
                <Divider sx={{ mb: 2 }} />
                <Stack spacing={2}>
                  <TextField
                    fullWidth
                    label="Checkpoint Name *"
                    size="small"
                    value={editCheckpoint}
                    onChange={(e) => setEditCheckpoint(e.target.value)}
                  />
                  <TextField
                    fullWidth
                    label="Date *"
                    size="small"
                    type="date"
                    value={editDate}
                    onChange={(e) => setEditDate(e.target.value)}
                    InputLabelProps={{ shrink: true }}
                  />
                </Stack>
              </Box>

              {/* Todo Management */}
              <Box mb={4}>
                <Typography variant="subtitle1" fontWeight="bold" gutterBottom>
                  Todo Management
                </Typography>
                <Divider sx={{ mb: 2 }} />
                
                {/* Add Todo */}
                <Box display="flex" gap={2} alignItems="center" mb={2}>
                  <TextField
                    fullWidth
                    size="small"
                    placeholder="Enter new todo..."
                    value={editTodoInput}
                    onChange={(e) => setEditTodoInput(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && handleAddTodo()}
                  />
                  <Button
                    variant="contained"
                    color="primary"
                    onClick={handleAddTodo}
                    disabled={!editTodoInput.trim()}
                    startIcon={<AddIcon />}
                  >
                    Add
                  </Button>
                </Box>

                {/* Todo List */}
                {editTodos.length === 0 ? (
                  <Alert severity="info">
                    No todos added yet.
                  </Alert>
                ) : (
                  <List dense>
                    {editTodos.map((todo, index) => (
                      <ListItem 
                        key={index}
                        sx={{ 
                          bgcolor: index === editingTodoIndex ? 'action.hover' : 'transparent',
                          borderRadius: 1,
                          mb: 0.5
                        }}
                      >
                        <Box sx={{ display: 'flex', alignItems: 'center', width: '100%' }}>
                          <TaskIcon fontSize="small" sx={{ mr: 2, color: 'action.active' }} />
                          
                          {index === editingTodoIndex ? (
                            <Box sx={{ display: 'flex', alignItems: 'center', flex: 1, gap: 1 }}>
                              <TextField
                                fullWidth
                                size="small"
                                value={editTempValue}
                                onChange={(e) => setEditTempValue(e.target.value)}
                                autoFocus
                                onKeyPress={(e) => e.key === 'Enter' && saveTodoEdit()}
                              />
                              <IconButton size="small" onClick={saveTodoEdit} color="success">
                                <CheckIcon />
                              </IconButton>
                              <IconButton size="small" onClick={cancelTodoEdit} color="error">
                                <ClearIcon />
                              </IconButton>
                            </Box>
                          ) : (
                            <>
                              <ListItemText 
                                primary={todo}
                                secondary={`Todo #${index + 1}`}
                                sx={{ flex: 1 }}
                              />
                              <Box>
                                <IconButton 
                                  size="small" 
                                  onClick={() => startTodoEdit(index)} 
                                  color="primary"
                                  sx={{ mr: 1 }}
                                >
                                  <EditIcon />
                                </IconButton>
                                <IconButton 
                                  size="small" 
                                  onClick={() => deleteTodo(index)} 
                                  color="error"
                                >
                                  <DeleteIcon />
                                </IconButton>
                              </Box>
                            </>
                          )}
                        </Box>
                      </ListItem>
                    ))}
                  </List>
                )}
              </Box>
            </Grid>

            {/* Right Column: File Management */}
            <Grid item xs={12} md={6}>
              <Typography variant="subtitle1" fontWeight="bold" gutterBottom>
                File Management
              </Typography>
              <Divider sx={{ mb: 2 }} />

              {/* Add File Section */}
              <Box mb={3} p={2} bgcolor="grey.50" borderRadius={1}>
                <Typography variant="subtitle2" gutterBottom>
                  Add New File
                </Typography>
                <Stack spacing={2}>
                  <Box display="flex" alignItems="center" gap={2}>
                    <Button
                      variant="outlined"
                      component="label"
                      startIcon={<UploadIcon />}
                      size="small"
                    >
                      Choose File
                      <input
                        type="file"
                        hidden
                        onChange={handleFileUpload}
                      />
                    </Button>
                    {newFile && (
                      <Typography variant="caption">
                        Selected: {newFile.name}
                      </Typography>
                    )}
                  </Box>
                  
                  <TextField
                    fullWidth
                    size="small"
                    label="File Name"
                    value={fileName}
                    onChange={(e) => setFileName(e.target.value)}
                    placeholder="Enter file name..."
                  />
                  
                  <Button
                    variant="contained"
                    color="primary"
                    onClick={handleAddFile}
                    disabled={!newFile && !fileName.trim()}
                    startIcon={<AddIcon />}
                    size="small"
                  >
                    Add File
                  </Button>
                </Stack>
              </Box>

              {/* File List */}
              {editFiles.length === 0 ? (
                <Alert severity="info">
                  No files attached to this checkpoint.
                </Alert>
              ) : (
                <Box>
                  <Typography variant="subtitle2" gutterBottom>
                    Attached Files ({editFiles.length})
                  </Typography>
                  <List dense>
                    {editFiles.map((file, index) => (
                      <ListItem
                        key={file.id}
                        sx={{
                          bgcolor: viewingFileIndex === index ? 'primary.50' : 'transparent',
                          borderRadius: 1,
                          mb: 0.5
                        }}
                      >
                        <Box sx={{ display: 'flex', alignItems: 'center', width: '100%' }}>
                          <FileIcon fontSize="small" sx={{ mr: 2, color: 'primary.main' }} />
                          <ListItemText
                            primary={
                              <Typography variant="body2" fontWeight="medium">
                                {file.name}
                              </Typography>
                            }
                            secondary={
                              <Typography variant="caption" color="text.secondary">
                                {file.type} â€¢ {file.size ? `${(file.size / 1024).toFixed(1)} KB` : 'Unknown size'}
                              </Typography>
                            }
                            sx={{ flex: 1 }}
                          />
                          <Box>
                            <Tooltip title="View">
                              <IconButton
                                size="small"
                                onClick={() => handleViewFile(index)}
                                color="info"
                                sx={{ mr: 1 }}
                              >
                                <ViewIcon />
                              </IconButton>
                            </Tooltip>
                            <Tooltip title="Download">
                              <IconButton
                                size="small"
                                onClick={() => handleDownloadFile(file)}
                                color="primary"
                                sx={{ mr: 1 }}
                              >
                                <DownloadIcon />
                              </IconButton>
                            </Tooltip>
                            <Tooltip title="Delete">
                              <IconButton
                                size="small"
                                onClick={() => handleDeleteFile(index)}
                                color="error"
                              >
                                <DeleteIcon />
                              </IconButton>
                            </Tooltip>
                          </Box>
                        </Box>
                      </ListItem>
                    ))}
                  </List>
                </Box>
              )}

              {/* File Preview Section */}
              {viewingFileIndex >= 0 && editFiles[viewingFileIndex] && (
                <Box mt={3} p={2} bgcolor="grey.50" borderRadius={1}>
                  <Typography variant="subtitle2" gutterBottom>
                    File Preview: {editFiles[viewingFileIndex].name}
                  </Typography>
                  <Card variant="outlined">
                    <CardContent>
                      <Typography variant="body2">
                        <strong>Name:</strong> {editFiles[viewingFileIndex].name}
                      </Typography>
                      <Typography variant="body2">
                        <strong>Type:</strong> {editFiles[viewingFileIndex].type}
                      </Typography>
                      <Typography variant="body2">
                        <strong>Size:</strong> {editFiles[viewingFileIndex].size ? `${(editFiles[viewingFileIndex].size / 1024).toFixed(2)} KB` : 'Unknown'}
                      </Typography>
                      <Typography variant="body2">
                        <strong>Uploaded:</strong> {formatDate(editFiles[viewingFileIndex].uploadedDate)}
                      </Typography>
                      <Box mt={2}>
                        <Button
                          variant="contained"
                          startIcon={<DownloadIcon />}
                          onClick={() => handleDownloadFile(editFiles[viewingFileIndex])}
                          size="small"
                        >
                          Download File
                        </Button>
                      </Box>
                    </CardContent>
                  </Card>
                </Box>
              )}
            </Grid>
          </Grid>
        </DialogContent>

        <DialogActions sx={{ px: 3, py: 2 }}>
          <Button 
            onClick={handleCloseDialog} 
            variant="outlined"
            startIcon={<CancelIcon />}
          >
            Cancel
          </Button>
          <Button 
            onClick={handleSaveCheckpoint} 
            variant="contained" 
            color="success"
            disabled={editTodos.length === 0 || !editCheckpoint.trim() || !editDate}
            startIcon={<SaveIcon />}
          >
            Save Changes
          </Button>
        </DialogActions>
      </Dialog>
    </>
  );
}
------------------------------------------------------------------------------------new table  --->import React, { useState, useMemo } from "react";
import {
  Box,
  Paper,
  Typography,
  Chip,
  Alert,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Divider,
  List,
  ListItem,
  ListItemText,
  Button,
  IconButton,
  TextField,
  Tooltip,
  Stack,
  Grid,
} from "@mui/material";
import {
  DataGrid,
  GridToolbarContainer,
  GridToolbarFilterButton,
  GridToolbarExport,
  GridToolbarQuickFilter,
  GridActionsCellItem,
} from "@mui/x-data-grid";
import {
  Visibility as ViewIcon,
  Edit as EditIcon,
  Delete as DeleteIcon,
  Attachment as AttachmentIcon,
  Task as TaskIcon,
  Add as AddIcon,
  Save as SaveIcon,
  Cancel as CancelIcon,
  Check as CheckIcon,
  Clear as ClearIcon,
  FolderOpen as FolderOpenIcon,
  CloudUpload as UploadIcon,
  InsertDriveFile as FileIcon,
} from "@mui/icons-material";

export default function CheckpointTable({ checkpoints, onDelete, onView, onEdit }) {
  const [editDialogOpen, setEditDialogOpen] = useState(false);
  const [selectedCheckpoint, setSelectedCheckpoint] = useState(null);
  const [editCheckpoint, setEditCheckpoint] = useState("");
  const [editDate, setEditDate] = useState("");
  const [editTodos, setEditTodos] = useState([]);
  const [editTodoInput, setEditTodoInput] = useState("");
  const [editingTodoIndex, setEditingTodoIndex] = useState(-1);
  const [editTempValue, setEditTempValue] = useState("");
  const [message, setMessage] = useState("");
  
  // File states for edit dialog
  const [editFiles, setEditFiles] = useState([]);
  const [newFile, setNewFile] = useState(null);
  const [fileName, setFileName] = useState("");

  const formatDate = (dateString) => {
    if (!dateString) return "N/A";
    try {
      return new Date(dateString).toLocaleDateString("en-US", {
        month: "short",
        day: "numeric",
        year: "numeric"
      });
    } catch (error) {
      console.error("Date formatting error:", error);
      return "Invalid Date";
    }
  };

  const formatDateForInput = (dateString) => {
    if (!dateString) return "";
    try {
      const date = new Date(dateString);
      return date.toISOString().split('T')[0];
    } catch (error) {
      console.error("Date input formatting error:", error);
      return "";
    }
  };

  // Open edit dialog
  const handleOpenEditDialog = (checkpoint) => {
    setSelectedCheckpoint(checkpoint);
    setEditCheckpoint(checkpoint.checkpoint || "");
    setEditDate(formatDateForInput(checkpoint.date));
    setEditTodos([...checkpoint.todos] || []);
    setEditFiles([...checkpoint.files] || []);
    setEditTodoInput("");
    setEditingTodoIndex(-1);
    setEditTempValue("");
    setFileName("");
    setNewFile(null);
    setMessage("");
    setEditDialogOpen(true);
  };

  // File handling in edit dialog
  const handleFileUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      setNewFile(file);
      setFileName(file.name);
    }
  };

  const handleAddFile = () => {
    if (!newFile && !fileName.trim()) {
      setMessage("Please select a file or enter a file name!");
      return;
    }

    const newFileObj = {
      id: Date.now(),
      name: fileName || newFile.name,
      type: newFile ? newFile.type : "Unknown",
      size: newFile ? newFile.size : 0,
      file: newFile,
      uploadedDate: new Date().toISOString()
    };

    setEditFiles(prev => [...prev, newFileObj]);
    setNewFile(null);
    setFileName("");
    setMessage(`Added file: ${newFileObj.name}`);
  };

  const handleEditFileName = (index, newName) => {
    if (!newName.trim()) {
      setMessage("File name cannot be empty!");
      return;
    }

    const updatedFiles = [...editFiles];
    updatedFiles[index] = { ...updatedFiles[index], name: newName.trim() };
    setEditFiles(updatedFiles);
    setMessage(`Renamed file to: ${newName}`);
  };

  const handleDeleteFile = (index) => {
    if (window.confirm(`Delete file "${editFiles[index].name}"?`)) {
      const updatedFiles = editFiles.filter((_, i) => i !== index);
      setEditFiles(updatedFiles);
      setMessage(`Deleted file: ${editFiles[index].name}`);
    }
  };

  // Todo functions
  const handleAddTodo = () => {
    if (!editTodoInput.trim()) {
      setMessage("Please enter todo text!");
      return;
    }
    
    const newTodo = editTodoInput.trim();
    setEditTodos(prev => [...prev, newTodo]);
    setEditTodoInput("");
    setMessage(`Added: "${newTodo}"`);
  };

  const startTodoEdit = (index) => {
    setEditingTodoIndex(index);
    setEditTempValue(editTodos[index]);
  };

  const saveTodoEdit = () => {
    if (!editTempValue.trim()) {
      setMessage("Todo cannot be empty!");
      return;
    }
    
    const updatedTodos = [...editTodos];
    updatedTodos[editingTodoIndex] = editTempValue.trim();
    setEditTodos(updatedTodos);
    setEditingTodoIndex(-1);
    setEditTempValue("");
    setMessage(`Todo #${editingTodoIndex + 1} updated`);
  };

  const cancelTodoEdit = () => {
    setEditingTodoIndex(-1);
    setEditTempValue("");
  };

  const deleteTodo = (index) => {
    if (window.confirm(`Delete todo #${index + 1}: "${editTodos[index]}"?`)) {
      setEditTodos(prev => prev.filter((_, i) => i !== index));
      
      if (index === editingTodoIndex) {
        setEditingTodoIndex(-1);
        setEditTempValue("");
      }
      
      setMessage(`Deleted todo #${index + 1}`);
    }
  };

  // Save checkpoint
  const handleSaveCheckpoint = () => {
    if (!editCheckpoint.trim()) {
      setMessage("Checkpoint name required!");
      return;
    }
    
    if (editTodos.length === 0) {
      setMessage("At least one todo required!");
      return;
    }

    if (!editDate) {
      setMessage("Date required!");
      return;
    }

    const updatedCheckpoint = {
      ...selectedCheckpoint,
      checkpoint: editCheckpoint.trim(),
      date: editDate,
      todos: editTodos,
      files: editFiles
    };

    onEdit(updatedCheckpoint);
    setEditDialogOpen(false);
    setMessage("");
  };

  const handleCloseDialog = () => {
    setEditDialogOpen(false);
    setMessage("");
  };

  // Prepare rows for DataGrid
  const rows = useMemo(() => {
    if (!Array.isArray(checkpoints)) return [];
    
    return checkpoints.map((cp, index) => ({
      id: cp._id || `id-${index}`,
      serialNo: index + 1,
      checkpoint: cp.checkpoint || "Unnamed",
      date: cp.date ? new Date(cp.date) : new Date(),
      formattedDate: formatDate(cp.date),
      createdAt: cp.createdAt ? formatDate(cp.createdAt) : formatDate(cp.date),
      todos: Array.isArray(cp.todos) ? cp.todos : [],
      files: Array.isArray(cp.files) ? cp.files : [],
      filesCount: Array.isArray(cp.files) ? cp.files.length : 0,
    }));
  }, [checkpoints]);

  // Define columns
  const columns = [
    {
      field: 'serialNo',
      headerName: 'S.NO',
      width: 80,
      renderCell: (params) => (
        <Chip 
          label={params.value} 
          size="small" 
          color="primary" 
          variant="outlined"
        />
      ),
    },
    {
      field: 'checkpoint',
      headerName: 'Checkpoint',
      flex: 1,
      minWidth: 200,
      renderCell: (params) => (
        <Box>
          <Typography variant="body2" fontWeight="medium">
            {params.value}
          </Typography>
          <Typography variant="caption" color="text.secondary">
            Created: {params.row.createdAt}
          </Typography>
        </Box>
      ),
    },
    {
      field: 'formattedDate',
      headerName: 'Date',
      width: 120,
    },
    {
      field: 'todos',
      headerName: 'Todos',
      flex: 1,
      minWidth: 200,
      renderCell: (params) => (
        <Stack spacing={0.5}>
          {params.row.todos.slice(0, 2).map((todo, i) => (
            <Box key={i} sx={{ display: "flex", alignItems: "center", gap: 1 }}>
              <TaskIcon fontSize="small" color="action" />
              <Typography variant="body2" noWrap sx={{ maxWidth: '200px' }}>
                {todo}
              </Typography>
            </Box>
          ))}
          {params.row.todos.length > 2 && (
            <Typography variant="caption" color="text.secondary">
              +{params.row.todos.length - 2} more
            </Typography>
          )}
        </Stack>
      ),
    },
    {
      field: 'files',
      headerName: 'Files',
      width: 120,
      renderCell: (params) => (
        <Box display="flex" alignItems="center" gap={1}>
          {params.row.filesCount > 0 && (
            <>
              <FolderOpenIcon fontSize="small" color="primary" />
              <Typography variant="body2" color="primary">
                {params.row.filesCount}
              </Typography>
            </>
          )}
        </Box>
      ),
    },
    {
      field: 'actions',
      headerName: 'Actions',
      type: 'actions',
      width: 150,
      getActions: (params) => [
        <GridActionsCellItem
          icon={<Tooltip title="View Details"><ViewIcon /></Tooltip>}
          label="View"
          onClick={() => onView(params.id)}
        />,
        <GridActionsCellItem
          icon={<Tooltip title="Edit"><EditIcon /></Tooltip>}
          label="Edit"
          onClick={() => {
            const checkpoint = checkpoints.find(cp => cp._id === params.id);
            if (checkpoint) handleOpenEditDialog(checkpoint);
          }}
        />,
        <GridActionsCellItem
          icon={<Tooltip title="Delete"><DeleteIcon /></Tooltip>}
          label="Delete"
          onClick={() => {
            if (window.confirm('Delete this checkpoint?')) {
              onDelete(params.id);
            }
          }}
          sx={{ color: 'error.main' }}
        />,
      ],
    },
  ];

  // Custom toolbar
  function CustomToolbar() {
    return (
      <GridToolbarContainer sx={{ p: 2, borderBottom: 1, borderColor: 'divider' }}>
        <Box sx={{ flexGrow: 1, display: 'flex', alignItems: 'center', gap: 2 }}>
          <Typography variant="h6" fontWeight="bold" color="primary">
            Checkpoints ({rows.length})
          </Typography>
          <Box sx={{ flexGrow: 1 }}>
            <GridToolbarQuickFilter 
              placeholder="Search checkpoints, todos..." 
              variant="outlined"
              size="small"
              sx={{ 
                width: { xs: '100%', sm: '300px' },
                '& .MuiInputBase-root': { height: 40 }
              }}
            />
          </Box>
        </Box>
        <Box sx={{ display: 'flex', gap: 1 }}>
          <GridToolbarFilterButton />
          <GridToolbarExport />
        </Box>
      </GridToolbarContainer>
    );
  }

  if (!checkpoints || checkpoints.length === 0) {
    return (
      <Alert severity="info" sx={{ mt: 2 }}>
        No checkpoints found.
      </Alert>
    );
  }

  return (
    <>
      {/* DataGrid Table */}
      <Paper elevation={0} variant="outlined" sx={{ height: 500, width: '100%' }}>
        <DataGrid
          rows={rows}
          columns={columns}
          slots={{ toolbar: CustomToolbar }}
          slotProps={{ toolbar: { showQuickFilter: true } }}
          initialState={{
            pagination: { paginationModel: { page: 0, pageSize: 10 } },
            sorting: { sortModel: [{ field: 'date', sort: 'desc' }] },
          }}
          pageSizeOptions={[5, 10, 25]}
          sx={{
            border: 'none',
            '& .MuiDataGrid-columnHeaders': {
              backgroundColor: 'primary.50',
              fontWeight: 'bold',
            },
          }}
        />
      </Paper>

      {/* Edit Dialog with File Management */}
      <Dialog 
        open={editDialogOpen} 
        onClose={handleCloseDialog}
        maxWidth="lg" 
        fullWidth
        PaperProps={{ sx: { maxHeight: '90vh' } }}
      >
        <DialogTitle>
          <Typography variant="h6" gutterBottom>
            Edit Checkpoint: {editCheckpoint}
          </Typography>
          <Box display="flex" gap={2} flexWrap="wrap">
            <Chip label={`${editTodos.length} Todos`} color="primary" size="small" />
            <Chip label={`${editFiles.length} Files`} color="secondary" size="small" />
          </Box>
        </DialogTitle>

        <DialogContent dividers sx={{ p: 3 }}>
          {message && (
            <Alert severity="info" sx={{ mb: 3 }} onClose={() => setMessage("")}>
              {message}
            </Alert>
          )}

          <Grid container spacing={3}>
            {/* Left Column: Basic Info & Todos */}
            <Grid item xs={12} md={6}>
              {/* Basic Info */}
              <Box mb={4}>
                <Typography variant="subtitle1" fontWeight="bold" gutterBottom>
                  Basic Information
                </Typography>
                <Divider sx={{ mb: 2 }} />
                <Stack spacing={2}>
                  <TextField
                    fullWidth
                    label="Checkpoint Name *"
                    size="small"
                    value={editCheckpoint}
                    onChange={(e) => setEditCheckpoint(e.target.value)}
                  />
                  <TextField
                    fullWidth
                    label="Date *"
                    size="small"
                    type="date"
                    value={editDate}
                    onChange={(e) => setEditDate(e.target.value)}
                    InputLabelProps={{ shrink: true }}
                  />
                </Stack>
              </Box>

              {/* Todo Management */}
              <Box mb={4}>
                <Typography variant="subtitle1" fontWeight="bold" gutterBottom>
                  Todo Management
                </Typography>
                <Divider sx={{ mb: 2 }} />
                
                {/* Add Todo */}
                <Box display="flex" gap={2} alignItems="center" mb={2}>
                  <TextField
                    fullWidth
                    size="small"
                    placeholder="Enter new todo..."
                    value={editTodoInput}
                    onChange={(e) => setEditTodoInput(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && handleAddTodo()}
                  />
                  <Button
                    variant="contained"
                    color="primary"
                    onClick={handleAddTodo}
                    disabled={!editTodoInput.trim()}
                    startIcon={<AddIcon />}
                  >
                    Add
                  </Button>
                </Box>

                {/* Todo List */}
                {editTodos.length === 0 ? (
                  <Alert severity="info">
                    No todos added yet.
                  </Alert>
                ) : (
                  <List dense>
                    {editTodos.map((todo, index) => (
                      <ListItem 
                        key={index}
                        sx={{ 
                          bgcolor: index === editingTodoIndex ? 'action.hover' : 'transparent',
                          borderRadius: 1,
                          mb: 0.5
                        }}
                      >
                        <Box sx={{ display: 'flex', alignItems: 'center', width: '100%' }}>
                          <TaskIcon fontSize="small" sx={{ mr: 2, color: 'action.active' }} />
                          
                          {index === editingTodoIndex ? (
                            <Box sx={{ display: 'flex', alignItems: 'center', flex: 1, gap: 1 }}>
                              <TextField
                                fullWidth
                                size="small"
                                value={editTempValue}
                                onChange={(e) => setEditTempValue(e.target.value)}
                                autoFocus
                                onKeyPress={(e) => e.key === 'Enter' && saveTodoEdit()}
                              />
                              <IconButton size="small" onClick={saveTodoEdit} color="success">
                                <CheckIcon />
                              </IconButton>
                              <IconButton size="small" onClick={cancelTodoEdit} color="error">
                                <ClearIcon />
                              </IconButton>
                            </Box>
                          ) : (
                            <>
                              <ListItemText 
                                primary={todo}
                                secondary={`Todo #${index + 1}`}
                                sx={{ flex: 1 }}
                              />
                              <Box>
                                <IconButton 
                                  size="small" 
                                  onClick={() => startTodoEdit(index)} 
                                  color="primary"
                                  sx={{ mr: 1 }}
                                >
                                  <EditIcon />
                                </IconButton>
                                <IconButton 
                                  size="small" 
                                  onClick={() => deleteTodo(index)} 
                                  color="error"
                                >
                                  <DeleteIcon />
                                </IconButton>
                              </Box>
                            </>
                          )}
                        </Box>
                      </ListItem>
                    ))}
                  </List>
                )}
              </Box>
            </Grid>

            {/* Right Column: File Management */}
            <Grid item xs={12} md={6}>
              <Typography variant="subtitle1" fontWeight="bold" gutterBottom>
                File Management
              </Typography>
              <Divider sx={{ mb: 2 }} />

              {/* Add File Section */}
              <Box mb={3} p={2} bgcolor="grey.50" borderRadius={1}>
                <Typography variant="subtitle2" gutterBottom>
                  Add New File
                </Typography>
                <Stack spacing={2}>
                  <Box display="flex" alignItems="center" gap={2}>
                    <Button
                      variant="outlined"
                      component="label"
                      startIcon={<UploadIcon />}
                      size="small"
                    >
                      Choose File
                      <input
                        type="file"
                        hidden
                        onChange={handleFileUpload}
                      />
                    </Button>
                    {newFile && (
                      <Typography variant="caption">
                        Selected: {newFile.name}
                      </Typography>
                    )}
                  </Box>
                  
                  <TextField
                    fullWidth
                    size="small"
                    label="File Name"
                    value={fileName}
                    onChange={(e) => setFileName(e.target.value)}
                    placeholder="Enter file name..."
                  />
                  
                  <Button
                    variant="contained"
                    color="primary"
                    onClick={handleAddFile}
                    disabled={!newFile && !fileName.trim()}
                    startIcon={<AddIcon />}
                    size="small"
                  >
                    Add File
                  </Button>
                </Stack>
              </Box>

              {/* File List */}
              {editFiles.length === 0 ? (
                <Alert severity="info">
                  No files attached to this checkpoint.
                </Alert>
              ) : (
                <Box>
                  <Typography variant="subtitle2" gutterBottom>
                    Attached Files ({editFiles.length})
                  </Typography>
                  <List dense>
                    {editFiles.map((file, index) => (
                      <ListItem
                        key={file.id}
                        sx={{
                          bgcolor: 'transparent',
                          borderRadius: 1,
                          mb: 0.5
                        }}
                      >
                        <Box sx={{ display: 'flex', alignItems: 'center', width: '100%' }}>
                          <FileIcon fontSize="small" sx={{ mr: 2, color: 'primary.main' }} />
                          <ListItemText
                            primary={
                              <Typography variant="body2" fontWeight="medium">
                                {file.name}
                              </Typography>
                            }
                            secondary={
                              <Typography variant="caption" color="text.secondary">
                                {file.type} â€¢ {file.size ? `${(file.size / 1024).toFixed(1)} KB` : 'Unknown size'}
                              </Typography>
                            }
                            sx={{ flex: 1 }}
                          />
                          <Box>
                            <Tooltip title="Edit">
                              <IconButton
                                size="small"
                                onClick={() => {
                                  const newName = prompt("Enter new file name:", file.name);
                                  if (newName) handleEditFileName(index, newName);
                                }}
                                color="primary"
                                sx={{ mr: 1 }}
                              >
                                <EditIcon />
                              </IconButton>
                            </Tooltip>
                            <Tooltip title="Delete">
                              <IconButton
                                size="small"
                                onClick={() => handleDeleteFile(index)}
                                color="error"
                              >
                                <DeleteIcon />
                              </IconButton>
                            </Tooltip>
                          </Box>
                        </Box>
                      </ListItem>
                    ))}
                  </List>
                </Box>
              )}
            </Grid>
          </Grid>
        </DialogContent>

        <DialogActions sx={{ px: 3, py: 2 }}>
          <Button 
            onClick={handleCloseDialog} 
            variant="outlined"
            startIcon={<CancelIcon />}
          >
            Cancel
          </Button>
          <Button 
            onClick={handleSaveCheckpoint} 
            variant="contained" 
            color="success"
            disabled={editTodos.length === 0 || !editCheckpoint.trim() || !editDate}
            startIcon={<SaveIcon />}
          >
            Save Changes
          </Button>
        </DialogActions>
      </Dialog>
    </>
  );
}